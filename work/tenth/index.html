<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      // 楽天ブックスの総合検索APIを使って製作してください。
      // answerの挙動を良く見てね！
      // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
      // https://webservice.rakuten.co.jp/api/bookstotalsearch/
      //
      //
      // [使うメソッド]
      // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
      // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
      // 以下は今回使う$.ajaxの基本的な形です。
      //
      $(function(){
        var currentPage = 1;
        var $ReKeyword;
        var error;
        
        // .search__btnクラスをクリックしたら,searchResultメソッドが発動するようにする。
        $('.search__btn').on('click',function(){
          searchResult();
        });
        // serchresultメソッドが発動したら、変数keywordにsearch__text__inputクラスと取得したvalue値を代入する。
        // もし、既存の検索ワードと同一の検索ワードが実行された場合、currentPage++で追加する。
        // 異なるワードで検索された場合、removeメソッドでlists_itemクラスを削除して、変数currentPage＝1で新規ページを作成し、変数Rekeywordに新たに検索した　 変数keywordを代入する。
        function searchResult(){
          $keyword = $('.search__text__input').val();
          if ($keyword == $ReKeyword){
            currentPage++; 
          }else{
          // 異なるキーワードの場合はremoveメソッドで、lists_itemクラスを削除する。
            $('.lists__item').remove();
            currentPage = 1;
            // もともとの検索ワードRekeywordに新しく検索したワードkeywordを代入する。
            $ReKeyword = $keyword;
          }
          // 楽天apiのajaxを取得するために情報を追記。パラメーターと件数２０件を指定する。keyword、page:currentpage(取得ページ)
          $.ajax({
            url:'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
            type: 'GET',
            dataType: 'json',
            data:{
              applicationId: '1019399324990976605',
              booksGenreId: '001',
              keyword: $keyword,
              hits: 20,
              page: currentPage
            },
          })
          // ajaxの取得に成功したら、requestメソッドを呼び引数dataを渡す。
          .done(function(data){
            request(data);
          })
          // 通信に失敗したら、requestFailメソッドに引数jqXHRを渡す。
          .fail(function(jqXHR){
            requestFail(jqXHR);
           });
         // requestメソッドが発動すれば引数にdataを渡す。もしdata件数が１以上あれば、resultメソッドに引数dataを渡す
         // dataが0の場合、apenndメソッドでerrormesageをcontainerクラスの要素内の後に表示させる。cssメソッドでtext-alignを適用させる。
         function request(data){
          if (data.count>0){
            result(data);
          }else{
            $('.container').append('<div class="error__message">検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。</div>').
            css('text-align','center');
          }
        }
         // ここでの処理は、ajaxのデータを元にhtmlを書き換える関数を定義している。
         // resultメソッドが発動すれば、引数dataを渡し、removeメソッドで後述のerror＿mesageクラスを消去する
         // まずは変数varに空の値を代入する。
         // each文で配列の繰り返し処理をする。data.Itemsに第一引数index、第二引数にvalue値を渡す。
         // 変数listにajaxで取得したデータを元にhtmlを書き換えるメソッドをかき、each文で繰り返しの処理をしている。
         // prependメソッドでクラスlistsの要素内の先頭に引数listを適用させる
         // largeImagerとすることで鮮明な画像となった
         function result(data){
          $('.error__message').remove();
            var list = '';
            $.each(data.Items, function(index, data){
              console.log(data);
            list +=
            '<li class="lists__item">' +
              '<div class="lists__item__inner">' +
                '<a href="'+data.Item.itemUrl+'"class="lists__item__link" target="blank">' +
                  '<img src="'+data.Item.largeImageUrl+'"class="lists__item__img" alt="">' +
                  '<p class="lists__item__detail">作品名：  '+data.Item.title+'</p>' +
                  '<p class="lists__item__detail">作者　：  '+data.Item.author+'</p>' +
                  '<p class="lists__item__detail">出版社：  '+data.Item.publisherName+'</p>' +
                '</a>' +
              '</div>' +
            '</li>'
          });
          $('.lists').prepend(list);
          }
          //  requestFailメソッドに引数jqXHRを渡す。まず、error_messageクラスをremoveメソッドで削除する。
          //  if文でjqXHR.statusとエラー内容を一致させて、containerクラスの要素の後に警告文を表示させる。
           function requestFail(jqXHR){
            $('.error__message').remove();
            console.log(jqXHR.status);
              if (jqXHR.status == 0){
                $('.container').append('<div class="error__message">0 通信が失敗しました。接続状況を確認し再度お試しください。</div>').css('text-align','center');
              } else if (jqXHR.status == 400){
                $('.container').append('<div class="error__message">400 正しい検索ワードを入れてください。(半角英数字2文字以上)</div>').css('text-align','center');
              } else if (jqXHR.status == 404){
                $('.container').append('<div class="error__message">404 正しい検索ワードを入れてください。(半角英数字2文字以上)</div>').css('text-align','center');
              } else if (jqXHR.status == 429){
                $('.container').append('<div class="error__message">429 しばらく時間を空けてから、ご利用ください。</div>').css('text-align','center');
                }
              }
           }
      });
    </script>
  </body>
</html>

'<a href="'+data.item.itemUrl+'"class="lists__item__link" target="_blank>+